# Raspberry Pi Camera Server

FastAPI-based camera server that exposes both MJPEG video feeds and JPEG snapshot
endpoints for multiple USB or Raspberry Pi cameras. Each camera can be
optionally mapped to its own port through an autogenerated Nginx config while a
central API handles configuration and a simple front-end viewer.

Typical uses include:

- Home or office surveillance with per-room ports you can bookmark or embed elsewhere
- Lab or workshop monitoring where each microscope/sensor camera is reachable on a predictable URL
- Demo stations or kiosks that expose MJPEG feeds to browsers or digital signage players

## Features
- Background frame grabber per camera using OpenCV
- MJPEG video and snapshot endpoints per camera via `http://<host>:<port>/` and `/snapshot` (Nginx proxy)
- Central FastAPI app with configuration APIs and built-in viewer
- Integrated web UI with camera dashboard, settings editor, and API reference
- JSON-based configuration persisted to `cameras.json`
- Hot reload of camera capture threads and regenerated Nginx mapping when configuration is updated via the API
- Camera discovery endpoint to list connected devices and avoid assigning the same camera twice
- Optional per-camera capture settings (resolution and FPS)

## Getting started

### Install dependencies
Install system prerequisites for OpenCV (varies by distro) and the Python
packages:

```bash
sudo apt update
sudo apt install python3-opencv python3-pip
pip3 install -r requirements.txt
```

### Configure cameras
Create a `cameras.json` file describing your devices. You can start from the
included example:

```bash
cp cameras.example.json cameras.json
```

Update each camera entry to point to the correct device index and (optionally)
choose a port for the Nginx-mapped endpoints. Device indices map to `/dev/video*`
devices on most Linux systems. Ports are auto-assigned starting at 8081 if
omitted. You can also set `width`, `height`, and `fps` to request a specific
capture resolution and frame rate for each camera.

### Run the server
Start the main FastAPI control plane (defaults to port 8000; override with
`APP_PORT=<port>`):

```bash
uvicorn app:app --host 0.0.0.0 --port 8000
```

On startup the app loads `cameras.json`, spins up background frame grabbers, and
generates `nginx.cameras.conf` that maps per-camera ports to the main API
streams. Visit `http://<host>:8000/` for the built-in viewer. Use the
navigation to jump between the live camera dashboard, the Settings page (to add
or edit cameras), and the API Docs page for endpoint details.

### Apply Nginx mapping

After the app starts, include the generated `nginx.cameras.conf` from your Nginx
configuration (for example, drop it into `/etc/nginx/conf.d/`). Then reload
Nginx:

```bash
sudo cp nginx.cameras.conf /etc/nginx/conf.d/cameras.conf
sudo systemctl reload nginx
```

Each camera will now be reachable via its configured port, e.g.:

- Video: `http://<host>:8081/`
- Snapshot: `http://<host>:8081/snapshot`

Nginx routing is a simple port fan-out to the FastAPI backend (default port 8000):

```
[Camera clients]
      | (ports 8081, 8082, ...)
   [Nginx proxy]
      | (proxied paths / and /snapshot)
   [FastAPI app :8000] -> /cam/<id>/video and /cam/<id>/snapshot
```

### Configure via API
You can update cameras at runtime with a POST to `/api/cameras`:

```bash
curl -X POST http://<host>:8000/api/cameras \
  -H "Content-Type: application/json" \
  -d '{
    "host": "0.0.0.0",
    "cameras": [
      {"id": "cam1", "name": "USB Cam 1", "device": 0, "port": 8081, "width": 1280, "height": 720, "fps": 30},
      {"id": "cam2", "name": "USB Cam 2", "device": 1, "port": 8082}
    ]
  }'
```

The server saves the configuration, restarts background capture threads, and
regenerates the Nginx mapping file.

You can discover attached cameras (and which ones are already assigned) with
`GET /api/devices`, which powers the Settings page picker.

## API overview

- `GET /` – Camera dashboard viewer
- `GET /settings` – UI for editing cameras and regenerating config
- `GET /api-docs` – HTML API reference shown in the UI
- `GET /api/cameras` – Return current configuration JSON
- `POST /api/cameras` – Persist configuration, restart captures, regenerate Nginx map
- `GET /api/devices` – Enumerate detected video devices and flag ones already configured
- `GET /cam/{id}/video` – MJPEG video stream for camera `{id}`
- `GET /cam/{id}/snapshot` – Single JPEG frame for camera `{id}`

## Licensing & contributions

This project is distributed under the [MIT License](LICENSE). Contributions are
welcome—please open an issue or pull request describing your change and the use
case it addresses.

## Notes
- OpenCV requires access to camera devices; ensure the user running the server
  has permissions for `/dev/video*`.
- If a camera fails to start, the server logs the error and continues with the
  remaining devices.
- You can also run `python app.py` to start uvicorn with default settings.
