"""
Raspberry Pi camera server exposing MJPEG video and snapshot endpoints per camera.

Run with uvicorn:
    uvicorn app:app --reload --host 0.0.0.0 --port 8000

The main FastAPI app provides configuration APIs and a basic viewer. Per-camera
ports are made available via an autogenerated Nginx configuration mapping to the
central FastAPI endpoints.
"""

import json
import os
import threading
import time
from pathlib import Path
from typing import Any, Dict, List, Optional

import cv2
import uvicorn
from fastapi import FastAPI, HTTPException
from fastapi.responses import HTMLResponse, Response, StreamingResponse
from pydantic import BaseModel, Field

CONFIG_PATH = Path("cameras.json")
NGINX_CONFIG_PATH = Path("nginx.cameras.conf")
DEFAULT_CAMERA_HOST = "0.0.0.0"
DEFAULT_START_PORT = 8081
APP_PORT = int(os.getenv("APP_PORT", "8000"))

app = FastAPI(title="Raspberry Pi Camera Server")


###############################################################################
# Camera capture
###############################################################################


class Camera:
    """Background frame grabber for a single video device."""

    def __init__(self, device_index: int):
        self.device_index = device_index
        self.cap = cv2.VideoCapture(device_index)
        if not self.cap.isOpened():
            raise RuntimeError(f"Could not open camera device {device_index}")

        self.frame_lock = threading.Lock()
        self.latest_frame = None
        self.running = True

        self.thread = threading.Thread(target=self._update_loop, daemon=True)
        self.thread.start()

    def _update_loop(self) -> None:
        while self.running:
            ret, frame = self.cap.read()
            if not ret:
                time.sleep(0.1)
                continue

            with self.frame_lock:
                self.latest_frame = frame
            time.sleep(1 / 30.0)

    def get_frame(self):
        with self.frame_lock:
            if self.latest_frame is None:
                return None
            return self.latest_frame.copy()

    def stop(self) -> None:
        self.running = False
        self.thread.join(timeout=1)
        self.cap.release()


def _encode_frame(frame, quality: int = 80) -> Optional[bytes]:
    ret, jpeg = cv2.imencode(".jpg", frame, [int(cv2.IMWRITE_JPEG_QUALITY), quality])
    if not ret:
        return None
    return jpeg.tobytes()


###############################################################################
# Configuration
###############################################################################


def default_config() -> Dict[str, Any]:
    return {"host": DEFAULT_CAMERA_HOST, "cameras": []}


def load_config() -> Dict[str, Any]:
    if CONFIG_PATH.exists():
        config = json.loads(CONFIG_PATH.read_text())
    else:
        config = default_config()

    assigned_cameras = assign_ports(config.get("cameras", []))
    if assigned_cameras != config.get("cameras", []):
        config["cameras"] = assigned_cameras
        save_config(config)
    else:
        config["cameras"] = assigned_cameras
    return config


def save_config(config: Dict[str, Any]) -> None:
    CONFIG_PATH.write_text(json.dumps(config, indent=2))


def assign_ports(cameras: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
    """Ensure each camera has a unique port, auto-assigning if omitted."""

    assigned: List[Dict[str, Any]] = []
    used_ports = {cam.get("port") for cam in cameras if cam.get("port")}
    next_port = DEFAULT_START_PORT

    for cam in cameras:
        cam_copy = dict(cam)
        port = cam_copy.get("port")
        if port is None:
            while next_port in used_ports:
                next_port += 1
            port = next_port
            next_port += 1
        cam_copy["port"] = port
        used_ports.add(port)
        assigned.append(cam_copy)

    return assigned


def generate_nginx_config(config: Dict[str, Any], output_path: Path = NGINX_CONFIG_PATH) -> None:
    """Write an nginx config mapping per-camera ports to the main API."""

    lines = [
        "# Auto-generated by app.py. Include this file from nginx.conf or conf.d.",
        "# Reload nginx after updating the camera configuration.",
        "",
    ]

    for cam in config.get("cameras", []):
        cam_id = cam["id"]
        port = cam["port"]
        lines.extend(
            [
                "server {",
                f"    listen {port};",
                "    location / {",
                f"        proxy_pass http://127.0.0.1:{APP_PORT}/cam/{cam_id}/video;",
                "        proxy_set_header Host $host;",
                "    }",
                "    location /snapshot {",
                f"        proxy_pass http://127.0.0.1:{APP_PORT}/cam/{cam_id}/snapshot;",
                "        proxy_set_header Host $host;",
                "    }",
                "}",
                "",
            ]
        )

    output_path.write_text("\n".join(lines))


###############################################################################
# Models
###############################################################################


class CameraConfig(BaseModel):
    id: str = Field(description="Unique camera identifier")
    name: str
    device: int = Field(description="cv2.VideoCapture device index")
    port: Optional[int] = Field(
        default=None, description="Port for the per-camera proxy (via Nginx)"
    )


class CamerasUpdate(BaseModel):
    host: str = Field(default=DEFAULT_CAMERA_HOST, description="Binding host")
    cameras: List[CameraConfig]


###############################################################################
# App state helpers
###############################################################################


CAMERAS: Dict[str, Camera] = {}
CAMERA_CONFIG: Dict[str, Any] = default_config()


def stop_cameras() -> None:
    for camera in CAMERAS.values():
        camera.stop()
    CAMERAS.clear()


def init_cameras() -> None:
    stop_cameras()

    for cam_cfg in CAMERA_CONFIG.get("cameras", []):
        cam_id = cam_cfg["id"]
        device_index = cam_cfg["device"]

        try:
            camera = Camera(device_index)
        except Exception as exc:  # noqa: BLE001
            print(f"Failed to start camera {cam_id}: {exc}")
            continue

        CAMERAS[cam_id] = camera
        print(f"Started camera {cam_id} on device {device_index}")


###############################################################################
# Shared streaming helpers for the main API
###############################################################################


def mjpeg_generator(cam_id: str):
    if cam_id not in CAMERAS:
        raise HTTPException(status_code=404, detail="Camera not found")

    camera = CAMERAS[cam_id]
    boundary = "frame"
    while True:
        frame = camera.get_frame()
        if frame is None:
            time.sleep(0.1)
            continue

        jpg_bytes = _encode_frame(frame, quality=80)
        if jpg_bytes is None:
            continue

        yield (
            b"--" + boundary.encode() + b"\r\n"
            b"Content-Type: image/jpeg\r\n\r\n" + jpg_bytes + b"\r\n"
        )


def get_snapshot_bytes(cam_id: str) -> bytes:
    if cam_id not in CAMERAS:
        raise HTTPException(status_code=404, detail="Camera not found")
    frame = CAMERAS[cam_id].get_frame()
    if frame is None:
        raise HTTPException(status_code=503, detail="No frame available yet")

    jpg_bytes = _encode_frame(frame, quality=90)
    if jpg_bytes is None:
        raise HTTPException(status_code=500, detail="Failed to encode frame")
    return jpg_bytes


###############################################################################
# API endpoints
###############################################################################


@app.on_event("startup")
def startup_event() -> None:
    global CAMERA_CONFIG
    CAMERA_CONFIG = load_config()
    init_cameras()
    generate_nginx_config(CAMERA_CONFIG)


@app.on_event("shutdown")
def shutdown_event() -> None:
    stop_cameras()


def _base_page(title: str, active: str, body: str) -> str:
    nav_items = {
        "home": ("/", "Cameras"),
        "settings": ("/settings", "Settings"),
        "docs": ("/api-docs", "API Docs"),
    }

    nav_html = "".join(
        f"<a class='nav-link {'active' if key == active else ''}' href='{href}'>"
        f"{label}</a>" for key, (href, label) in nav_items.items()
    )

    template = """
    <html>
    <head>
        <title>__TITLE__</title>
        <meta charset=\"utf-8\" />
        <style>
            :root {
                color-scheme: light dark;
                --bg: #0f172a;
                --panel: #111827;
                --accent: #3b82f6;
                --text: #e5e7eb;
                --muted: #94a3b8;
                --border: #1f2937;
                font-family: 'Inter', system-ui, -apple-system, sans-serif;
            }
            body {
                margin: 0 auto;
                max-width: 1100px;
                padding: 24px 16px 48px;
                color: var(--text);
                background: linear-gradient(180deg, #0b1224 0%, #0f172a 35%, #0f172a 100%);
            }
            h1 { margin: 0 0 16px; letter-spacing: -0.02em; }
            p { color: var(--muted); }
            .nav {
                display: flex;
                gap: 12px;
                margin: 16px 0 24px;
                border-bottom: 1px solid var(--border);
                padding-bottom: 10px;
            }
            .nav-link {
                color: var(--muted);
                text-decoration: none;
                padding: 8px 12px;
                border-radius: 8px;
                transition: background 0.15s, color 0.15s;
            }
            .nav-link:hover { color: var(--text); background: #111827; }
            .nav-link.active {
                background: rgba(59, 130, 246, 0.15);
                color: #bfdbfe;
                border: 1px solid rgba(59, 130, 246, 0.4);
            }
            .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px; }
            .card {
                background: var(--panel);
                border: 1px solid var(--border);
                border-radius: 12px;
                padding: 16px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.25);
            }
            .pill {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                background: rgba(59, 130, 246, 0.1);
                color: #bfdbfe;
                padding: 6px 10px;
                border-radius: 999px;
                font-size: 12px;
                border: 1px solid rgba(59,130,246,0.25);
            }
            code { background: rgba(255,255,255,0.04); padding: 2px 4px; border-radius: 6px; }
            .btn {
                background: var(--accent);
                color: white;
                padding: 10px 14px;
                border-radius: 10px;
                border: none;
                cursor: pointer;
                font-weight: 600;
                box-shadow: 0 10px 30px rgba(59,130,246,0.25);
            }
            .btn-secondary {
                background: #1f2937;
                color: var(--text);
                border: 1px solid var(--border);
            }
            .input, select {
                width: 100%;
                padding: 10px 12px;
                border-radius: 10px;
                border: 1px solid var(--border);
                background: #0b1224;
                color: var(--text);
            }
            table { width: 100%; border-collapse: collapse; margin-top: 12px; }
            th, td { text-align: left; padding: 8px; border-bottom: 1px solid var(--border); }
            .muted { color: var(--muted); font-size: 14px; }
            .status { margin-top: 12px; font-weight: 600; }
            a { color: #93c5fd; }
        </style>
    </head>
    <body>
        <h1>Pi Camera Server</h1>
        <div class=\"nav\">__NAV__</div>
        __BODY__
    </body>
    </html>
    """

    return (
        template.replace("__NAV__", nav_html)
        .replace("__BODY__", body)
        .replace("__TITLE__", title)
    )


@app.get("/", response_class=HTMLResponse)
def index_page():
    host = CAMERA_CONFIG.get("host", DEFAULT_CAMERA_HOST)
    cards = []
    for cam in CAMERA_CONFIG.get("cameras", []):
        cam_id = cam["id"]
        port = cam.get("port")
        name = cam.get("name", cam_id)
        cards.append(
            f"""
            <div class='card'>
                <div style='display:flex; justify-content: space-between; align-items:center;'>
                    <div>
                        <div class='pill'>üé• Camera ¬∑ {cam_id}</div>
                        <h3 style='margin:8px 0 4px;'>{name}</h3>
                        <p class='muted'>Device index: {cam['device']}</p>
                    </div>
                    <div style='text-align:right;'>
                        <div class='muted'>Port</div>
                        <div style='font-weight:700;'>:{port}</div>
                    </div>
                </div>
                <div style='margin:12px 0;'>
                    <img src='/cam/{cam_id}/video' style='width:100%; border:1px solid var(--border); border-radius:10px;'>
                </div>
                <div style='display:flex; gap:12px; align-items:center; flex-wrap:wrap;'>
                    <img id='snap-{cam_id}' src='/cam/{cam_id}/snapshot' style='width:140px; border:1px solid var(--border); border-radius:8px;'>
                    <div>
                        <div class='muted'>Main API</div>
                        <code>/cam/{cam_id}/video</code><br>
                        <code>/cam/{cam_id}/snapshot</code>
                        <div style='margin-top:6px;' class='muted'>Nginx mapped:</div>
                        <code>http://{host}:{port}/</code><br>
                        <code>http://{host}:{port}/snapshot</code>
                    </div>
                </div>
            </div>
            """
        )

    body = f"""
        <p class='muted'>Streams are available via the main API and per-camera ports generated in nginx.cameras.conf.</p>
        <div class='card-grid'>
            {''.join(cards) if cards else '<div class="card"><p>No cameras configured yet. Add one in Settings.</p></div>'}
        </div>
        <script>
            setInterval(() => {{
                const imgs = document.querySelectorAll("img[id^='snap-']");
                imgs.forEach(img => {{
                    const base = img.src.split('?')[0];
                    img.src = base + "?t=" + Date.now();
                }});
            }}, 2000);
        </script>
    """

    return _base_page("Pi Camera Server", "home", body)


@app.get("/settings", response_class=HTMLResponse)
def settings_page():
    body = """
        <div class='card'>
            <div style='display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;'>
                <div>
                    <div class='pill'>‚öôÔ∏è Setup</div>
                    <h2 style='margin:8px 0 4px;'>Camera configuration</h2>
                    <p class='muted'>Edit the host and cameras, then save to regenerate nginx.cameras.conf and restart capture threads.</p>
                </div>
                <button class='btn' onclick='saveConfig()'>üíæ Save changes</button>
            </div>
            <div style='margin-top:16px;'>
                <label class='muted'>Binding host</label>
                <input class='input' id='host' placeholder='0.0.0.0'>
            </div>
            <div style='margin-top:16px; display:flex; justify-content:space-between; align-items:center;'>
                <h3 style='margin:0;'>Cameras</h3>
                <button class='btn-secondary btn' onclick='addRow()'>Ôºã Add camera</button>
            </div>
            <div style='overflow-x:auto;'>
                <table id='cam-table'>
                    <thead>
                        <tr><th>ID</th><th>Name</th><th>Device</th><th>Port</th><th></th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id='status' class='status muted'></div>
        </div>
        <script>
            const tbody = document.querySelector('#cam-table tbody');
            function addRow(cam={id:'', name:'', device:'', port:''}) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input class='input' value='${cam.id}' placeholder='cam1'></td>
                    <td><input class='input' value='${cam.name}' placeholder='USB Cam'></td>
                    <td><input class='input' value='${cam.device}' type='number' min='0' style='width:90px'></td>
                    <td><input class='input' value='${cam.port ?? ''}' type='number' min='0' style='width:100px'></td>
                    <td style='width:60px; text-align:right;'><button class='btn-secondary btn' onclick='this.closest("tr").remove()'>‚úñ</button></td>
                `;
                tbody.appendChild(tr);
            }

            async function loadConfig() {
                const res = await fetch('/api/cameras');
                const data = await res.json();
                document.querySelector('#host').value = data.host || '';
                tbody.innerHTML = '';
                (data.cameras || []).forEach(addRow);
            }

            async function saveConfig() {
                const status = document.getElementById('status');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                const cameras = rows.map(r => {
                    const [id,name,device,port] = Array.from(r.querySelectorAll('input')).map(i => i.value.trim());
                    return { id, name, device: Number(device), port: port ? Number(port) : null };
                }).filter(c => c.id);
                const payload = { host: document.getElementById('host').value || '0.0.0.0', cameras };
                status.textContent = 'Saving‚Ä¶';
                try {
                    const res = await fetch('/api/cameras', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });
                    if (!res.ok) throw new Error(await res.text());
                    await res.json();
                    status.textContent = 'Saved! Cameras restarted and nginx config regenerated.';
                    status.classList.remove('muted');
                    setTimeout(() => location.href='/', 800);
                } catch (err) {
                    status.textContent = 'Failed: ' + err;
                    status.classList.remove('muted');
                }
            }

            loadConfig();
        </script>
    """
    return _base_page("Settings ¬∑ Pi Camera Server", "settings", body)


@app.get("/api-docs", response_class=HTMLResponse)
def api_docs_page():
    host = CAMERA_CONFIG.get("host", DEFAULT_CAMERA_HOST)
    rows = []
    for cam in CAMERA_CONFIG.get("cameras", []):
        cam_id = cam["id"]
        port = cam.get("port")
        rows.append(
            f"<tr><td>{cam_id}</td><td>/cam/{cam_id}/video</td><td>/cam/{cam_id}/snapshot</td><td>http://{host}:{port}/</td><td>http://{host}:{port}/snapshot</td></tr>"
        )

    body = f"""
        <div class='card'>
            <div class='pill'>üìò API</div>
            <h2 style='margin:8px 0 4px;'>HTTP endpoints</h2>
            <p class='muted'>Reference for integrating streams into dashboards or other services.</p>
            <h3>Configuration</h3>
            <ul>
                <li><code>GET /api/cameras</code> ‚Äî returns the current host and camera list.</li>
                <li><code>POST /api/cameras</code> ‚Äî update host and cameras; regenerates nginx.cameras.conf and restarts capture.</li>
            </ul>
            <h3>Streaming</h3>
            <p class='muted'>Replace <code>{{cam_id}}</code> with a configured camera ID.</p>
            <ul>
                <li><code>/cam/{{cam_id}}/video</code> ‚Äî MJPEG stream (multipart/x-mixed-replace).</li>
                <li><code>/cam/{{cam_id}}/snapshot</code> ‚Äî single JPEG frame.</li>
            </ul>
            <h3>Per-camera ports (Nginx proxy)</h3>
            <p class='muted'>Enable by including <code>nginx.cameras.conf</code> in your nginx configuration.</p>
            <table>
                <thead><tr><th>Camera</th><th>Video (API)</th><th>Snapshot (API)</th><th>Video (port)</th><th>Snapshot (port)</th></tr></thead>
                <tbody>{''.join(rows) if rows else '<tr><td colspan="5" class="muted">No cameras configured.</td></tr>'}</tbody>
            </table>
        </div>
    """
    return _base_page("API Docs ¬∑ Pi Camera Server", "docs", body)


@app.get("/api/cameras")
def get_cameras():
    return CAMERA_CONFIG


@app.post("/api/cameras")
def set_cameras(data: CamerasUpdate):
    global CAMERA_CONFIG
    camera_dicts = [cam.dict() for cam in data.cameras]
    CAMERA_CONFIG = {"host": data.host, "cameras": assign_ports(camera_dicts)}
    save_config(CAMERA_CONFIG)
    init_cameras()
    generate_nginx_config(CAMERA_CONFIG)
    return {"status": "ok", "cameras": CAMERA_CONFIG}


@app.get("/cam/{cam_id}/video")
def video_stream(cam_id: str):
    return StreamingResponse(
        mjpeg_generator(cam_id),
        media_type="multipart/x-mixed-replace; boundary=frame",
    )


@app.get("/cam/{cam_id}/snapshot")
def snapshot(cam_id: str):
    img_bytes = get_snapshot_bytes(cam_id)
    return Response(content=img_bytes, media_type="image/jpeg")


if __name__ == "__main__":
    uvicorn.run("app:app", host="0.0.0.0", port=APP_PORT, reload=False)
